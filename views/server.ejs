<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Console <%= server.name %> | Redwave</title>
    <link rel="stylesheet" href="/style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="sidebar">
        <h2>Redwave ‚ö°</h2>
        <div class="sidebar-menu">
            <a href="/" class="menu-item">üè† Servidores</a>
            <a href="/server/<%= server.id %>" class="menu-item active">‚öôÔ∏è <%= server.name %></a>
            <a href="/loja" class="menu-item">üõçÔ∏è Loja</a>
            <a href="/perfil" class="menu-item">üë§ Perfil</a>
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <div>
                <h1>Console do Servidor: <%= server.name %></h1>
                <p>Status: <strong id="server-status"><span class="status-dot <%= server.status %>"></span> <%= server.status.toUpperCase() %></strong></p>
            </div>
            <div class="actions">
                <button id="start-btn" onclick="startServer()" class="btn btn-success">INICIAR</button>
                <button id="stop-btn" onclick="stopServer()" class="btn btn-danger">PARAR</button>
            </div>
        </div>

        <div class="card">
            <h3>Terminal de Processo</h3>
            <div class="terminal-window" id="terminal">
                <div class="log-line">[SISTEMA] Console conectado.</div>
                <% server.logs.slice(-50).forEach(log => { %>
                    <div class="log-line <%= (log.includes('üö® ERROR') || log.includes('[ERRO]')) ? 'error-line' : '' %>"><%= log %></div>
                <% }) %>
            </div>
            
            <div class="command-bar">
                <input type="text" id="command-input" placeholder="Digite um comando aqui (s√≥ funciona ONLINE)" autocomplete="off" disabled>
                <button onclick="sendCommand()" id="send-btn" disabled>Enviar</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const serverId = '<%= server.id %>';
        const terminal = document.getElementById('terminal');
        const statusElement = document.getElementById('server-status');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const commandInput = document.getElementById('command-input');
        const sendBtn = document.getElementById('send-btn');
        let currentStatus = '<%= server.status %>';

        // --- Fun√ß√µes de UI e Status (GARANTINDO HABILITA√á√ÉO) ---

        function updateUI(status) {
            currentStatus = status;
            const dotClass = status === 'online' ? 'online' : status === 'offline' ? 'offline' : status === 'cloning' ? 'cloning' : 'error';
            const dot = `<span class="status-dot ${dotClass}"></span>`;
            
            statusElement.innerHTML = `${dot} ${status.toUpperCase()}`;
            
            // Habilita/Desabilita bot√µes
            startBtn.disabled = status === 'online' || status === 'cloning' || status === 'error' || status === 'iniciando';
            stopBtn.disabled = status !== 'online';
            
            // Habilita/Desabilita barra de comando
            commandInput.disabled = status !== 'online';
            sendBtn.disabled = status !== 'online';
        }

        // --- Fun√ß√µes de Controle (Socket.io) ---
        
        function sendCommand() {
            const command = commandInput.value.trim();
            if (command && currentStatus === 'online') {
                socket.emit('send-command', { serverId, command });
                commandInput.value = '';
            }
        }
        
        function startServer() {
            if (currentStatus !== 'online') {
                socket.emit('start-server', serverId);
                updateUI('iniciando');
            }
        }

        function stopServer() {
            if (currentStatus === 'online') {
                socket.emit('stop-server', serverId);
                updateUI('parando');
            }
        }

        // --- Eventos ---

        socket.on(`log-${serverId}`, (msg) => {
            const div = document.createElement('div');
            // Garante que logs longos quebrem a linha no console
            div.className = msg.includes('üö® ERROR') || msg.includes('[ERRO]') ? 'log-line error-line' : 'log-line'; 
            div.textContent = msg;
            terminal.appendChild(div);
            terminal.scrollTop = terminal.scrollHeight;
        });

        socket.on('status-change', (data) => {
            if (data.id == serverId) {
                updateUI(data.status);
            }
        });
        
        // Envia comando ao apertar ENTER
        commandInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); 
                sendCommand();
            }
        });
        
        updateUI(currentStatus);
    </script>
</body>
</html>
